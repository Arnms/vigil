# Step 3: μ•λ¦Ό μ‹μ¤ν…

**λ©ν‘**: λ‹¤μ–‘ν• μ±„λ„μ„ ν†µν• μ•λ¦Ό μ „μ†΅ μ‹μ¤ν… κµ¬ν„
**κΈ°κ°„**: Day 5-6
**μƒνƒ**: β… μ™„λ£

---

## π“‹ μ›ν¬ν”λ΅μ°

### 1. Notification λ¨λ“ κµ¬ν„

**λ©ν‘**: μ•λ¦Ό μ‹μ¤ν…μ κΈ°λ³Έ κµ¬μ΅° κµ¬μ„±

- [x] Notification λ¨λ“ μƒμ„±
  - `src/modules/notification/notification.module.ts` β…
  - `src/modules/notification/notification.service.ts` β…
  - `src/modules/notification/notification.controller.ts` β…

- [x] NotificationChannel κ΄€λ¦¬ API
  - POST /api/notification-channels (μ±„λ„ λ“±λ΅) β…
  - GET /api/notification-channels (μ±„λ„ λ©λ΅) β…
  - PATCH /api/notification-channels/:id (μ±„λ„ μμ •) β…
  - DELETE /api/notification-channels/:id (μ±„λ„ μ‚­μ ) β…

- [x] Strategy Pattern κµ¬ν„
  - `src/modules/notification/strategies/notification.strategy.ts` β…
  - `src/modules/notification/strategies/email.strategy.ts` β…
  - `src/modules/notification/strategies/slack.strategy.ts` β…

---

### 2. μ΄λ©”μΌ μ•λ¦Ό κµ¬ν„

**λ©ν‘**: Nodemailerλ¥Ό μ΄μ©ν• μ΄λ©”μΌ μ•λ¦Ό μ „μ†΅

- [x] Nodemailer μμ΅΄μ„± μ„¤μΉ β…
  ```
  npm install nodemailer
  npm install --save-dev @types/nodemailer
  ```

- [x] μ΄λ©”μΌ μ„¤μ • β…
  - `src/config/mail.config.ts` β…
  - SMTP μ„¤μ • (ν™κ²½ λ³€μμ—μ„ λ΅λ“) β…
  - λ°μ‹ μ μ •λ³΄ μ„¤μ • β…

- [x] EmailNotificationStrategy κµ¬ν„ β…
  - μ΄λ©”μΌ ν…ν”λ¦Ώ μƒμ„± λλ” κ°„λ‹¨ν• HTML κµ¬μ„± β…
  - μ΄λ©”μΌ μ λ© μƒμ„± (μ: "[Vigil] APIμ„λ²„ - DOWN") β…
  - μ΄λ©”μΌ λ³Έλ¬Έ μ‘μ„± (μ—”λ“ν¬μΈνΈλ…, λ°μƒμ‹κ°„, μƒνƒ, μ—λ¬ λ©”μ‹μ§€) β…
  - μμ‹ μ κ΄€λ¦¬ β…

- [x] μ΄λ©”μΌ μ „μ†΅ λ΅μ§ β…
  - λ™κΈ°/λΉ„λ™κΈ° μ „μ†΅ κ³ λ ¤ β…
  - μ¬μ‹λ„ λ΅μ§ (μµλ€ 3ν) β…
  - μ „μ†΅ μ‹¤ν¨ λ΅κΉ… β…

---

### 3. Slack μ›Ήν›… ν†µν•©

**λ©ν‘**: Slackμ„ ν†µν• μ•λ¦Ό μ „μ†΅

- [x] Slack API ν΄λΌμ΄μ–ΈνΈ μ„¤μ • β…
  - μ›Ήν›… URL κ΄€λ¦¬ β…
  - HTTP ν΄λΌμ΄μ–ΈνΈ μ‚¬μ© β…

- [x] SlackNotificationStrategy κµ¬ν„ β…
  - λ©”μ‹μ§€ ν¬λ§· μ •μ (Block Kit μ‚¬μ©) β…
  - μƒνƒμ— λ”°λ¥Έ μƒ‰μƒ κµ¬λ¶„ (π”΄ DOWN, πΆ UP, π΅ DEGRADED) β…
  - μ—”λ“ν¬μΈνΈ μ •λ³΄ ν¬ν•¨ β…
  - λ€μ‹λ³΄λ“ λ§ν¬ ν¬ν•¨ β…

- [x] Slack λ©”μ‹μ§€ μ „μ†΅ λ΅μ§ β…
  - POST μ”μ²­ μν–‰ β…
  - μ‘λ‹µ μ½”λ“ ν™•μΈ (200, 201) β…
  - μ‹¤ν¨ μ‹ μ¬μ‹λ„ λλ” λ΅κΉ… β…

---

### 4. μ¤‘λ³µ μ•λ¦Ό λ°©μ§€

**λ©ν‘**: Redisλ¥Ό μ΄μ©ν• μ¤‘λ³µ μ•λ¦Ό λ°©μ§€

- [x] Redis μΊμ‹± μ „λµ μ„¤κ³„ β…
  - ν‚¤ ν•μ‹: `alert:{endpointId}:{status}` β…
  - TTL: 300μ΄ (5λ¶„) β…

- [x] μ•λ¦Ό μ „μ†΅ μ „ ν™•μΈ λ΅μ§ β…
  ```
  1. Redisμ—μ„ ν‚¤ ν™•μΈ β…
  2. ν‚¤κ°€ μ΅΄μ¬ν•λ©΄ μ•λ¦Ό μ¤ν‚µ β…
  3. ν‚¤κ°€ μ—†μΌλ©΄ μ•λ¦Ό μ „μ†΅ β…
  4. μ•λ¦Ό μ „μ†΅ ν›„ Redisμ— ν‚¤ μ €μ¥ (TTL μ„¤μ •) β…
  ```

- [x] μ¤‘λ³µ λ°©μ§€ μ„λΉ„μ¤ κµ¬ν„ β…
  - `src/modules/notification/services/duplicate-prevention.service.ts` β…
  - check λ©”μ„λ“ (μ΄λ―Έ μ•λ¦Ό μ „μ†΅ μ—¬λ¶€ ν™•μΈ) β…
  - mark λ©”μ„λ“ (μ•λ¦Ό μ „μ†΅ κΈ°λ΅) β…

---

### 5. μ•λ¦Ό νΈλ¦¬κ±° μ—°κ²°

**λ©ν‘**: μƒνƒ λ³€κ²½ μ‹ μλ™μΌλ΅ μ•λ¦Ό μ „μ†΅

- [x] Endpoint μƒνƒ λ³€κ²½ κ°μ§€ β…
  - DOWN μƒνƒ μ „ν™ μ‹ μ•λ¦Ό β…
  - UP μƒνƒλ΅ λ³µκµ¬ μ‹ μ•λ¦Ό β…
  - DEGRADED μƒνƒ κ°μ§€ μ‹ μ•λ¦Ό (μ„ νƒμ‚¬ν•­) β…

- [x] μ΄λ²¤νΈ κΈ°λ° μ•λ¦Ό λ°μ†΅ β…
  - μƒνƒ λ³€κ²½ μ΄λ²¤νΈ κµ¬λ… β…
  - NotificationService.send() νΈμ¶ β…
  - μ—¬λ¬ μ±„λ„λ΅ λ™μ‹ μ „μ†΅ β…

- [x] μ•λ¦Ό κΈ°λ΅ μ €μ¥ (μ„ νƒμ‚¬ν•­) β…
  - `src/modules/notification/entities/notification-log.entity.ts` β…
  - μ „μ†΅ μ‹κ°„, μ±„λ„, μ„±κ³µ/μ‹¤ν¨ κΈ°λ΅ β…

---

## β… μ™„λ£ μ²΄ν¬λ¦¬μ¤νΈ

μ‘μ—…μ΄ μ™„λ£λμ—λ”μ§€ ν™•μΈν•©λ‹λ‹¤:

- [x] NotificationChannel APIκ°€ μ •μƒ μ‘λ™ν•λ”κ°€? β…
  ```bash
  POST /api/notification-channels β…
  GET /api/notification-channels β…
  ```

- [x] μ΄λ©”μΌ μ•λ¦Όμ΄ μ •μƒ μ‘λ™ν•λ”κ°€? β…
  - ν…μ¤νΈ μ΄λ©”μΌ μ£Όμ†λ΅ μ „μ†΅ β…
  - μ λ©, λ³Έλ¬Έ ν•μ‹ ν™•μΈ β…

- [x] Slack μ•λ¦Όμ΄ μ •μƒ μ‘λ™ν•λ”κ°€? β…
  - Slack μ±„λ„μ—μ„ λ©”μ‹μ§€ μμ‹  β…
  - λ©”μ‹μ§€ ν•μ‹ ν™•μΈ β…

- [x] μ¤‘λ³µ μ•λ¦Ό λ°©μ§€κ°€ μ‘λ™ν•λ”κ°€? β…
  - 5λ¶„ λ‚΄μ— κ°™μ€ μ•λ¦Όμ΄ μ—¬λ¬ λ² μ „μ†΅λμ§€ μ•μ β…
  - 5λ¶„ ν›„μ—λ” μƒλ΅μ΄ μ•λ¦Ό μ „μ†΅λ¨ β…

- [x] μƒνƒ λ³€κ²½ μ‹ μ•λ¦Όμ΄ μλ™ μ „μ†΅λλ”κ°€? β…
  - μ—”λ“ν¬μΈνΈκ°€ DOWN μƒνƒλ΅ λ³€κ²½ μ‹ μ•λ¦Ό β…
  - DOWNμ—μ„ UPμΌλ΅ λ³µκµ¬ μ‹ μ•λ¦Ό β…
  - λ¨λ“  μ„¤μ •λ μ±„λ„λ΅ μ•λ¦Ό μ „μ†΅ β…

- [x] μ•λ¦Ό μ‹¤ν¨ μ‹ λ΅κΉ…μ΄ μ •μƒ μ‘λ™ν•λ”κ°€? β…
  - Winston λ΅κ±° μ‚¬μ© β…
  - μ‹¤ν¨ μ›μΈ κΈ°λ΅ β…

---

## π“ ν™κ²½ λ³€μ μ¶”κ°€

```env
# Email (Gmail μμ‹)
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
MAIL_FROM_ADDRESS=alerts@vigil.com
MAIL_FROM_NAME=Vigil Alert

# Slack
SLACK_WEBHOOK_URL=https://hooks.slack.com/services/YOUR/WEBHOOK/URL

# ν…μ¤νΈ μ΄λ©”μΌ
TEST_EMAIL=test@example.com
```

---

## π§ ν…μ¤νΈ μ‹λ‚λ¦¬μ¤

### μ΄λ©”μΌ μ „μ†΅ ν…μ¤νΈ
1. ν…μ¤νΈ μ΄λ©”μΌ μ±„λ„ μƒμ„±
2. μ—”λ“ν¬μΈνΈλ¥Ό DOWN μƒνƒλ΅ λ³€κ²½
3. ν…μ¤νΈ μ΄λ©”μΌ μ£Όμ†λ΅ μ•λ¦Ό μμ‹  ν™•μΈ

### Slack μ•λ¦Ό ν…μ¤νΈ
1. Slack μ›Ήν›… URL μ„¤μ •
2. μ—”λ“ν¬μΈνΈλ¥Ό DOWN μƒνƒλ΅ λ³€κ²½
3. Slack μ±„λ„μ—μ„ μ•λ¦Ό λ©”μ‹μ§€ μμ‹  ν™•μΈ

### μ¤‘λ³µ λ°©μ§€ ν…μ¤νΈ
1. μ²« λ²μ§Έ μ•λ¦Ό μ „μ†΅
2. 5μ΄ ν›„ κ°™μ€ μƒνƒ λ³€κ²½ μ‹λ„
3. μ•λ¦Όμ΄ μ „μ†΅λμ§€ μ•μ ν™•μΈ
4. 5λ¶„ ν›„ κ°™μ€ μƒνƒ λ³€κ²½
5. μƒλ΅μ΄ μ•λ¦Ό μ „μ†΅ ν™•μΈ

---

## π”— κ΄€λ ¨ λ¬Έμ„

- [FEATURE_SPECIFICATIONS.md](../docs/FEATURE_SPECIFICATIONS.md#4-μ•λ¦Ό-μ‹μ¤ν…) - μ•λ¦Ό μ‹μ¤ν… λ…μ„Έ
- [API_SPECIFICATIONS.md](../docs/API_SPECIFICATIONS.md#5-μ•λ¦Ό-μ±„λ„-api) - μ•λ¦Ό μ±„λ„ API

## π“ μ°Έκ³  μλ£

- [Nodemailer κ³µμ‹ λ¬Έμ„](https://nodemailer.com/)
- [Slack Incoming Webhooks](https://api.slack.com/messaging/webhooks)
- [Strategy Pattern](https://refactoring.guru/design-patterns/strategy)

## β΅οΈ λ‹¤μ λ‹¨κ³„

β†’ [04-statistics-api.md](./04-statistics-api.md)

**λ‹¤μ λ‹¨κ³„ λ‚΄μ©**:
- Statistics λ¨λ“ κµ¬ν„
- κ°€λ™λ¥ , μ‘λ‹µ μ‹κ°„ ν†µκ³„ API
- μΈμ‹λνΈ νμ¤ν† λ¦¬ API
- μΏΌλ¦¬ μµμ ν™” λ° μΈλ±μ¤ μ¶”κ°€
