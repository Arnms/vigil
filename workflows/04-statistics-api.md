# Step 4: ν†µκ³„ API & μµμ ν™”

**λ©ν‘**: ν†µκ³„ λ°μ΄ν„° μ΅°ν API λ° μΏΌλ¦¬ μµμ ν™”
**κΈ°κ°„**: Day 7
**μƒνƒ**: β… μ™„λ£

---

## π“‹ μ›ν¬ν”λ΅μ°

### 1. Statistics λ¨λ“ κµ¬ν„

**λ©ν‘**: ν†µκ³„ λ°μ΄ν„° μ΅°ν κΈ°λ¥ λ¨λ“ν™”

- [x] Statistics λ¨λ“ μƒμ„± β…
  - `src/modules/statistics/statistics.module.ts` β…
  - `src/modules/statistics/statistics.service.ts` β…
  - `src/modules/statistics/statistics.controller.ts` β…

- [x] ν†µκ³„ λ°μ΄ν„° μΊμ‹± μ „λµ β…
  - Redisλ¥Ό μ΄μ©ν• μμ£Ό μ΅°νλλ” ν†µκ³„ μΊμ‹± β…
  - TTL μ„¤μ • (μ: 1λ¶„) β…

---

### 2. κ°€λ™λ¥  API κµ¬ν„

**λ©ν‘**: μ—”λ“ν¬μΈνΈμ κ°€λ™λ¥  μ΅°ν

- [x] GET /api/endpoints/:id/uptime κµ¬ν„ β…
  - Query Parameter: period (24h, 7d, 30d, custom) β…
  - Query Parameter: startDate, endDate (custom μ‹) β…

- [x] κ°€λ™λ¥  κ³„μ‚° λ΅μ§ β…
  ```
  κ°€λ™λ¥  = (μ„±κ³µ νμ / μ „μ²΄ μ²΄ν¬ νμ) Γ— 100 β…
  ```

- [x] TypeORM QueryBuilderλ΅ μ§‘κ³„ μΏΌλ¦¬ μ‘μ„± β…
  - checkIntervalμ— λ”°λ¥Έ μμƒ μ²΄ν¬ μ κ³„μ‚° β…
  - μ‹¤μ  μ„±κ³µ/μ‹¤ν¨ νμ κ³„μ‚° β…
  - μΏΌλ¦¬ μ„±λ¥ μµμ ν™” β…

- [x] μ‘λ‹µ ν•μ‹ β…
  ```json
  {
    "endpointId": "uuid",
    "period": "24h",
    "uptime": 99.5,
    "totalChecks": 1440,
    "successfulChecks": 1433,
    "failedChecks": 7,
    "startDate": "2025-10-15T12:00:00.000Z",
    "endDate": "2025-10-16T12:00:00.000Z"
  }
  ```

---

### 3. μ‘λ‹µ μ‹κ°„ ν†µκ³„ API κµ¬ν„

**λ©ν‘**: μ‘λ‹µ μ‹κ°„μ μƒμ„Έ ν†µκ³„ μ κ³µ

- [x] GET /api/endpoints/:id/response-time κµ¬ν„ β…
  - Query Parameter: period (24h, 7d, 30d) β…

- [x] ν†µκ³„ μ§€ν‘ κ³„μ‚° β…
  - ν‰κ·  μ‘λ‹µ μ‹κ°„ β…
  - μµμ† μ‘λ‹µ μ‹κ°„ β…
  - μµλ€ μ‘λ‹µ μ‹κ°„ β…
  - P50 (μ¤‘μ•™κ°’) β…
  - P95 (95 λ°±λ¶„μ„μ) β…
  - P99 (99 λ°±λ¶„μ„μ) β…

- [x] PostgreSQL Percentile ν•¨μ μ‚¬μ© β…
  ```sql
  PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY responseTime) β…
  ```

- [x] μ‹κ³„μ—΄ λ°μ΄ν„° μ κ³µ β…
  - μ‹κ°„λ‹Ή ν‰κ·  μ‘λ‹µ μ‹κ°„ β…
  - μ°¨νΈ λ λ”λ§μ© λ°μ΄ν„° ν¬μΈνΈ β…

- [x] μ‘λ‹µ ν•μ‹ β…
  ```json
  {
    "endpointId": "uuid",
    "period": "24h",
    "statistics": {
      "average": 145,
      "min": 89,
      "max": 523,
      "p50": 134,
      "p95": 298,
      "p99": 456
    },
    "timeSeries": [
      {
        "timestamp": "2025-10-16T00:00:00.000Z",
        "avgResponseTime": 150
      }
    ]
  }
  ```

---

### 4. μ „μ²΄ μ—”λ“ν¬μΈνΈ ν†µκ³„ API

**λ©ν‘**: λ¨λ“  μ—”λ“ν¬μΈνΈμ μ”μ•½ ν†µκ³„ μ κ³µ

- [x] GET /api/statistics/overview κµ¬ν„ β…
  - μ „μ²΄ μ—”λ“ν¬μΈνΈ μ β…
  - μƒνƒλ³„ λ¶„λ¥ (UP, DOWN, DEGRADED, UNKNOWN) β…
  - μ „μ²΄ κ°€λ™λ¥  β…
  - ν™μ„± μΈμ‹λνΈ μ β…
  - 24μ‹κ°„ μΈμ‹λνΈ λ°μƒ μ β…
  - ν‰κ·  μ‘λ‹µ μ‹κ°„ β…

- [x] μ‘λ‹µ ν•μ‹ β…
  ```json
  {
    "totalEndpoints": 10,
    "statusBreakdown": {
      "UP": 8,
      "DOWN": 1,
      "DEGRADED": 1,
      "UNKNOWN": 0
    },
    "overallUptime": 98.5,
    "activeIncidents": 1,
    "totalIncidentsLast24h": 3,
    "averageResponseTime": 156
  }
  ```

---

### 5. μΈμ‹λνΈ νμ¤ν† λ¦¬ API

**λ©ν‘**: μΈμ‹λνΈ μ΄λ ¥ μ΅°ν λ° ν†µκ³„

- [x] GET /api/incidents κµ¬ν„ β…
  - Query Parameter: endpointId, status (active, resolved) β…
  - νμ΄μ§€λ„¤μ΄μ… β…

- [x] GET /api/incidents/:id κµ¬ν„ β…
  - μΈμ‹λνΈ μƒμ„Έ μ •λ³΄ β…
  - κ΄€λ ¨ μ²΄ν¬ κ²°κ³Ό ν¬ν•¨ β…

- [x] μΈμ‹λνΈ ν†µκ³„ κ³„μ‚° β…
  - μ΄ μΈμ‹λνΈ μ β…
  - ν‰κ·  λ³µκµ¬ μ‹κ°„ (MTTR - Mean Time To Recovery) β…
  - κ°€μ¥ κΈ΄ μ¥μ•  μ‹κ°„ β…
  - μ›”λ³„ μΈμ‹λνΈ λ°μƒ μ¶”μ΄ β…

---

### 6. μ—”λ“ν¬μΈνΈλ³„ μ„±λ¥ λΉ„κµ

**λ©ν‘**: λ¨λ“  μ—”λ“ν¬μΈνΈμ μ„±λ¥μ„ λΉ„κµ

- [x] GET /api/statistics/comparison κµ¬ν„ β…
  - κ°€λ™λ¥  μμ„ β…
  - ν‰κ·  μ‘λ‹µ μ‹κ°„ μμ„ β…
  - μΈμ‹λνΈ λ°μƒ λΉλ„ β…
  - μ•μ •μ„± μ μ κ³„μ‚° β…

- [x] μ•μ •μ„± μ μ κ³„μ‚° λ΅μ§ β…
  ```
  μ•μ •μ„± μ μ = (κ°€λ™λ¥  Γ— 0.6) + ((1 - μ •κ·ν™”λ ν‰κ·  μ‘λ‹µμ‹κ°„) Γ— 0.3) + ((1 - μ •κ·ν™”λ μΈμ‹λνΈ λΉλ„) Γ— 0.1) β…
  ```

- [x] μ‘λ‹µ ν•μ‹ (μ •λ ¬λ λ¦¬μ¤νΈ) β…
  ```json
  {
    "data": [
      {
        "endpointId": "uuid",
        "name": "API Server",
        "uptime24h": 99.5,
        "avgResponseTime": 145,
        "incidentCount": 0,
        "stabilityScore": 98.5,
        "rank": 1
      }
    ]
  }
  ```

---

### 7. λ°μ΄ν„°λ² μ΄μ¤ μΏΌλ¦¬ μµμ ν™”

**λ©ν‘**: ν†µκ³„ μ΅°ν μ„±λ¥ μµμ ν™”

- [x] μΈλ±μ¤ ν™•μΈ λ° μ¶”κ°€ β…
  - check_resultsμ— λ³µν•© μΈλ±μ¤ ν™•μΈ β…
  - incidentsμ— ν•„μ”ν• μΈλ±μ¤ ν™•μΈ β…

- [x] EXPLAIN ANALYZE μ‹¤ν–‰ β…
  - μ£Όμ” μΏΌλ¦¬ μ„±λ¥ λ¶„μ„ β…
  - μΈλ±μ¤ μ‚¬μ© μ—¬λ¶€ ν™•μΈ β…

- [x] μΏΌλ¦¬ μµμ ν™” β…
  - N+1 λ¬Έμ  ν•΄κ²° β…
  - TypeORM leftJoinAndSelect ν™μ© β…
  - λ¶ν•„μ”ν• μ΅°μΈ μ κ±° β…

- [x] λ·° μƒμ„± (μ„ νƒμ‚¬ν•­) β…
  - `v_endpoint_response_stats` (μ‘λ‹µ μ‹κ°„ ν†µκ³„) β…
  - `v_active_incidents` (ν™μ„± μΈμ‹λνΈ) β…

---

## β… μ™„λ£ μ²΄ν¬λ¦¬μ¤νΈ

μ‘μ—…μ΄ μ™„λ£λμ—λ”μ§€ ν™•μΈν•©λ‹λ‹¤:

- [x] κ°€λ™λ¥  APIκ°€ μ •μƒ μ‘λ™ν•λ”κ°€? β…
  ```bash
  GET /api/endpoints/:id/uptime?period=24h β…
  ```

- [x] μ‘λ‹µ μ‹κ°„ ν†µκ³„ APIκ°€ μ •μƒ μ‘λ™ν•λ”κ°€? β…
  ```bash
  GET /api/endpoints/:id/response-time?period=24h β…
  ```

- [x] μ „μ²΄ ν†µκ³„ APIκ°€ μ •μƒ μ‘λ™ν•λ”κ°€? β…
  ```bash
  GET /api/statistics/overview β…
  ```

- [x] μΈμ‹λνΈ μ΅°ν APIκ°€ μ •μƒ μ‘λ™ν•λ”κ°€? β…
  ```bash
  GET /api/incidents β…
  GET /api/incidents/:id β…
  ```

- [x] μ„±λ¥ λΉ„κµ APIκ°€ μ •μƒ μ‘λ™ν•λ”κ°€? β…
  ```bash
  GET /api/statistics/comparison β…
  ```

- [x] ν†µκ³„ μ΅°ν μ„±λ¥μ΄ 200ms μ΄ν•μΈκ°€? β…
  - API μ‘λ‹µ μ‹κ°„ μΈ΅μ • β…
  - λ€λ‰ λ°μ΄ν„° ν…μ¤νΈ β…

- [x] μΊμ‹±μ΄ μ •μƒ μ‘λ™ν•λ”κ°€? β…
  - Redisμ—μ„ μΊμ‹ λ°μ΄ν„° ν™•μΈ β…
  - λ°λ³µ μ”μ²­ μ‹ μ„±λ¥ κ°μ„  ν™•μΈ β…

---

## π“ ν…μ¤νΈ λ°μ΄ν„° μƒμ„±

```sql
-- ν…μ¤νΈ λ°μ΄ν„° μƒμ„± μ¤ν¬λ¦½νΈ
-- μ—¬λ¬ μ—”λ“ν¬μΈνΈμ μ²΄ν¬ κ²°κ³Ό λ€λ‰ μƒμ„±
-- ν†µκ³„ κ³„μ‚° μ •ν™•μ„± ν™•μΈ
```

---

## π§ μ„±λ¥ ν…μ¤νΈ

### μ„±λ¥ λ©ν‘
- λ‹¨μΌ μ—”λ“ν¬μΈνΈ ν†µκ³„ μ΅°ν: < 100ms
- μ „μ²΄ ν†µκ³„ μ΅°ν: < 200ms
- λ€λ‰ λ°μ΄ν„° μ²λ¦¬: 10λ§ κ° μ²΄ν¬ κ²°κ³Ό μ΅°ν < 500ms

### ν…μ¤νΈ λ°©λ²•
```bash
# ApacheBench λλ” Artillery μ‚¬μ©
ab -n 100 -c 10 http://localhost:3000/api/statistics/overview
```

---

## π”— κ΄€λ ¨ λ¬Έμ„

- [FEATURE_SPECIFICATIONS.md](../docs/FEATURE_SPECIFICATIONS.md#5-ν†µκ³„-λ°-λ¶„μ„) - ν†µκ³„ λ…μ„Έ
- [API_SPECIFICATIONS.md](../docs/API_SPECIFICATIONS.md#3-ν†µκ³„-api) - ν†µκ³„ API λ…μ„Έ
- [DATABASE_SCHEMA.md](../docs/DATABASE_SCHEMA.md#5-λ°μ΄ν„°λ² μ΄μ¤-ν•¨μ-λ°-λ·°) - DB ν•¨μ/λ·°

## π“ μ°Έκ³  μλ£

- [TypeORM QueryBuilder](https://typeorm.io/select-query-builder)
- [PostgreSQL Aggregate Functions](https://www.postgresql.org/docs/current/functions-aggregate.html)

## β΅οΈ λ‹¤μ λ‹¨κ³„

β†’ [05-frontend-basic.md](./05-frontend-basic.md)

**λ‹¤μ λ‹¨κ³„ λ‚΄μ©**:
- Vite + React + TS ν”„λ΅μ νΈ μ…‹μ—…
- λ μ΄μ•„μ›ƒ λ° λΌμ°ν…
- μ—”λ“ν¬μΈνΈ λ©λ΅ λ° λ“±λ΅ νΌ
- API μ„λΉ„μ¤ μ—°κ²°
