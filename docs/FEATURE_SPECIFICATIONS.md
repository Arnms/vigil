# 기능 명세서

## 1. 엔드포인트 관리

### 1.1 엔드포인트 등록

**기능 설명**
모니터링할 API 엔드포인트를 시스템에 등록합니다.

**입력 정보**
- 이름 (필수): 엔드포인트 식별 이름
- URL (필수): 모니터링할 API URL
- HTTP 메소드 (필수): GET, POST, PUT, DELETE, PATCH, HEAD, OPTIONS
- 헤더 (선택): JSON 형식의 HTTP 헤더
- 바디 (선택): JSON 형식의 요청 바디
- 체크 간격 (필수): 30초, 1분, 5분, 10분, 30분, 1시간 중 선택
- 예상 응답 코드 (필수): 정상 응답으로 간주할 HTTP 상태 코드 (기본값: 200)
- 타임아웃 임계값 (필수): 응답 대기 시간 (기본값: 5000ms)

**출력 결과**
- 엔드포인트 ID
- 생성 시간
- 초기 상태: UNKNOWN

**비즈니스 규칙**
- URL은 유효한 HTTP/HTTPS 형식이어야 함
- 체크 간격은 최소 30초 이상
- 타임아웃은 최소 1000ms, 최대 60000ms
- 동일한 URL이 이미 등록되어 있으면 경고 표시 (중복 허용)

**예외 처리**
- 잘못된 URL 형식: 400 Bad Request
- 필수 필드 누락: 400 Bad Request
- 서버 오류: 500 Internal Server Error

---

### 1.2 엔드포인트 조회

**기능 설명**
등록된 엔드포인트 목록 또는 특정 엔드포인트 상세 정보를 조회합니다.

**조회 유형**

**1.2.1 전체 목록 조회**
- 페이지네이션 지원 (기본: 20개/페이지)
- 필터링 옵션:
  - 상태별 (UP, DOWN, DEGRADED, UNKNOWN)
  - 활성화 여부 (isActive)
- 정렬 옵션:
  - 이름 (오름차순/내림차순)
  - 생성일 (최신순/오래된순)
  - 마지막 체크 시간
  - 현재 상태

**1.2.2 단일 엔드포인트 상세 조회**
- 기본 정보 (이름, URL, 메소드 등)
- 현재 상태 및 마지막 응답 시간
- 최근 24시간 체크 결과 요약
- 최근 인시던트 이력 (최대 10개)
- 현재 가동률

**출력 결과**
- 엔드포인트 전체 정보
- 실시간 상태
- 통계 요약

---

### 1.3 엔드포인트 수정

**기능 설명**
등록된 엔드포인트의 설정을 수정합니다.

**수정 가능 항목**
- 이름
- URL
- HTTP 메소드
- 헤더
- 바디
- 체크 간격
- 예상 응답 코드
- 타임아웃 임계값
- 활성화 여부 (isActive)

**비즈니스 규칙**
- 수정 시 기존 체크 스케줄은 즉시 업데이트
- 비활성화하면 스케줄링 중단, 활성화하면 즉시 재시작
- 수정 이력은 별도 로그로 기록 (추후 구현)

**출력 결과**
- 수정된 엔드포인트 정보
- 수정 시간

---

### 1.4 엔드포인트 삭제

**기능 설명**
등록된 엔드포인트를 시스템에서 삭제합니다.

**비즈니스 규칙**
- Soft Delete 방식 (실제 데이터는 유지, isDeleted 플래그 사용)
- 관련된 체크 결과 및 인시던트는 유지
- 스케줄링 작업은 즉시 중단

**출력 결과**
- 삭제 성공 메시지
- 삭제 시간

---

## 2. 자동 헬스 체크

### 2.1 헬스 체크 실행

**기능 설명**
Bull Queue를 이용하여 각 엔드포인트를 주기적으로 체크합니다.

**체크 프로세스**
1. 스케줄된 시간에 작업 실행
2. 설정된 URL로 HTTP 요청 전송
   - 설정된 메소드, 헤더, 바디 사용
   - 타임아웃 설정 적용
3. 응답 수신 및 분석
   - 응답 시간 측정
   - 상태 코드 확인
   - 타임아웃 여부 확인
4. 결과 저장 및 상태 업데이트
5. 필요시 알림 트리거

**성공 기준**
- 응답 상태 코드가 예상 코드와 일치
- 응답 시간이 타임아웃 임계값 이내
- 네트워크 오류 없음

**실패 기준**
- 예상하지 않은 상태 코드
- 타임아웃 초과
- 네트워크 오류
- DNS 해석 실패

---

### 2.2 상태 판정 로직

**상태 유형**
- **UP**: 정상 작동 중
- **DOWN**: 완전 장애
- **DEGRADED**: 성능 저하 (응답은 오지만 느림)
- **UNKNOWN**: 아직 체크되지 않음

**판정 규칙**

**UP 조건**
- 최근 체크 성공
- 응답 시간이 타임아웃의 80% 이내
- 연속 실패 횟수 0회

**DEGRADED 조건**
- 최근 체크 성공
- 응답 시간이 타임아웃의 80% 초과
- 또는 최근 5회 중 1-2회 실패

**DOWN 조건**
- 최근 체크 실패
- 또는 연속 3회 이상 실패
- 또는 최근 5회 중 3회 이상 실패

**UNKNOWN 조건**
- 엔드포인트 등록 직후
- 또는 체크 비활성화 상태

---

### 2.3 체크 결과 저장

**저장 정보**
- 엔드포인트 ID
- 체크 시간
- 성공/실패 여부
- 응답 시간 (ms)
- HTTP 상태 코드
- 에러 메시지 (실패 시)

**데이터 보관 정책**
- 최근 7일 데이터: 모든 체크 결과 보관
- 7일 ~ 30일: 시간당 1개 샘플만 보관
- 30일 이상: 일별 통계만 보관
- 자동 정리 작업: 매일 자정 실행

---

## 3. 실시간 모니터링

### 3.1 WebSocket 연결

**기능 설명**
클라이언트와 서버 간 실시간 양방향 통신을 제공합니다.

**연결 프로세스**
1. 클라이언트가 WebSocket 연결 요청
2. 서버가 연결 수락
3. 클라이언트를 적절한 Room에 참여시킴
4. 초기 데이터 전송

**지원 이벤트**

**서버 → 클라이언트**
- `endpoint:status-changed`: 엔드포인트 상태 변경
- `endpoint:created`: 새 엔드포인트 등록
- `endpoint:updated`: 엔드포인트 정보 수정
- `endpoint:deleted`: 엔드포인트 삭제
- `check:completed`: 헬스 체크 완료
- `incident:started`: 인시던트 발생
- `incident:resolved`: 인시던트 해결

**클라이언트 → 서버**
- `subscribe:endpoint`: 특정 엔드포인트 구독
- `unsubscribe:endpoint`: 구독 해제
- `subscribe:all`: 전체 엔드포인트 구독

---

### 3.2 실시간 데이터 업데이트

**업데이트 시나리오**

**상태 변경 시**
```json
{
  "event": "endpoint:status-changed",
  "data": {
    "endpointId": "uuid",
    "previousStatus": "UP",
    "currentStatus": "DOWN",
    "timestamp": "2025-10-16T12:00:00Z",
    "responseTime": 5432,
    "errorMessage": "Timeout exceeded"
  }
}
```

**인시던트 발생 시**
```json
{
  "event": "incident:started",
  "data": {
    "incidentId": "uuid",
    "endpointId": "uuid",
    "endpointName": "API Server",
    "startedAt": "2025-10-16T12:00:00Z",
    "failureCount": 3
  }
}
```

---

## 4. 알림 시스템

### 4.1 알림 트리거 조건

**DOWN 상태 알림**
- 연속 3회 실패 시 즉시 알림
- 조건: 이전 상태가 UP 또는 DEGRADED

**복구 알림**
- DOWN 상태에서 UP 상태로 전환 시
- 조건: 인시던트 해결됨

**DEGRADED 상태 알림**
- 성능 저하 감지 시 알림
- 조건: 연속 5회 체크 중 응답 시간이 임계값의 80% 초과

---

### 4.2 이메일 알림

**기능 설명**
Nodemailer를 이용하여 이메일 알림을 발송합니다.

**알림 내용**
- 제목: `[Vigil] {엔드포인트명} - {상태}`
- 본문:
  - 엔드포인트 정보
  - 발생 시간
  - 상태 변경 내역
  - 에러 메시지 (있을 경우)
  - 대시보드 링크

**발송 규칙**
- 수신자: 환경 변수에 설정된 이메일 주소
- 재발송 제한: 동일 엔드포인트에 대해 5분 내 1회만
- 실패 시 최대 3회 재시도

---

### 4.3 Slack 알림

**기능 설명**
Slack Webhook을 이용하여 메시지를 전송합니다.

**메시지 포맷**
```json
{
  "text": "🚨 API Monitor Alert",
  "blocks": [
    {
      "type": "header",
      "text": {
        "type": "plain_text",
        "text": "엔드포인트명 - DOWN"
      }
    },
    {
      "type": "section",
      "fields": [
        {
          "type": "mrkdwn",
          "text": "*URL:*\nhttps://api.example.com"
        },
        {
          "type": "mrkdwn",
          "text": "*발생 시간:*\n2025-10-16 12:00:00"
        }
      ]
    }
  ]
}
```

**발송 규칙**
- 웹훅 URL: 환경 변수에 설정
- 재발송 제한: 동일 엔드포인트에 대해 5분 내 1회만
- 실패 시 에러 로그 기록

---

### 4.4 중복 알림 방지

**구현 방법**
Redis를 이용한 캐싱

**로직**
1. 알림 발송 전 Redis에서 키 확인
   - 키 형식: `alert:{endpointId}:{status}`
2. 키가 존재하면 발송 스킵
3. 키가 없으면 발송 후 키 생성
   - TTL: 300초 (5분)

---

## 5. 통계 및 분석

### 5.1 가동률 계산

**기능 설명**
특정 기간 동안의 엔드포인트 가동률을 계산합니다.

**계산 방식**
```
가동률 = (성공 횟수 / 전체 체크 횟수) × 100
```

**기간별 통계**
- 최근 24시간
- 최근 7일
- 최근 30일
- 사용자 지정 기간

**출력 형식**
```json
{
  "endpointId": "uuid",
  "period": "24h",
  "uptime": 99.5,
  "totalChecks": 1440,
  "successfulChecks": 1433,
  "failedChecks": 7
}
```

---

### 5.2 응답 시간 분석

**기능 설명**
응답 시간의 통계를 제공합니다.

**제공 지표**
- 평균 응답 시간
- 최소 응답 시간
- 최대 응답 시간
- P50 (중앙값)
- P95 (95 백분위수)
- P99 (99 백분위수)

**시계열 데이터**
- 시간당 평균 응답 시간
- 일별 평균 응답 시간
- 차트 렌더링용 데이터 포인트 제공

---

### 5.3 인시던트 히스토리

**기능 설명**
발생한 인시던트의 이력을 조회합니다.

**조회 옵션**
- 엔드포인트별
- 기간별
- 해결 여부별 (진행중/해결됨)

**출력 정보**
- 인시던트 ID
- 시작 시간
- 해결 시간
- 지속 시간
- 실패 횟수
- 에러 메시지

**통계 요약**
- 총 인시던트 수
- 평균 복구 시간 (MTTR)
- 가장 긴 장애 시간
- 월별 인시던트 발생 추이

---

### 5.4 엔드포인트별 성능 비교

**기능 설명**
등록된 모든 엔드포인트의 성능을 비교합니다.

**비교 지표**
- 가동률 순위
- 평균 응답 시간 순위
- 인시던트 발생 빈도
- 안정성 점수

**안정성 점수 계산**
```
안정성 점수 = (가동률 × 0.6) + ((1 - 정규화된 평균 응답시간) × 0.3) + ((1 - 정규화된 인시던트 빈도) × 0.1)
```

**출력 형식**
- 테이블 형태
- 차트 (막대 그래프, 레이더 차트)
- 엑셀 다운로드 (추후 구현)

---

## 6. 비기능 요구사항

### 6.1 성능

- API 응답 시간: 평균 200ms 이하
- 동시 엔드포인트 모니터링: 최소 100개
- WebSocket 동시 연결: 최소 50개
- 데이터베이스 쿼리 최적화: 인덱스 활용

### 6.2 보안

- 환경 변수를 통한 민감 정보 관리
- SQL Injection 방지 (TypeORM 사용)
- XSS 방지 (입력 검증)
- CORS 설정

### 6.3 확장성

- 수평 확장 가능한 아키텍처
- Redis 기반 분산 캐싱
- Bull Queue 기반 작업 분산

### 6.4 모니터링

- 애플리케이션 로그 (Winston)
- 에러 추적
- 성능 메트릭 수집 (추후 구현)

---

## 7. 제외 사항 (v1.0)

다음 기능은 초기 버전에서 제외하고 추후 구현합니다:

- 사용자 인증 및 권한 관리
- 팀 기능 및 멀티 테넌시
- 커스텀 알림 규칙
- SSL 인증서 만료 체크
- Public Status Page
- API 키 인증
- 멀티 리전 체크
- 데이터 백업 및 복원
- 감사 로그
